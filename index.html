<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SuperScan - Premium Inventory & POS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #6b21a8 100%);
            color: #f5f5f5;
            margin: 0;
            transition: background 0.3s ease, color 0.3s ease;
        }
        body.light-mode {
            background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);
            color: #1a1a1a;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #1a1a1a;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        .header.light-mode {
            background: #ffffff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .header a {
            color: #d4af37;
            margin: 0 1rem;
            font-weight: 600;
            transition: color 0.3s ease;
        }
        .header a:hover {
            color: #b8972e;
        }
        .header .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: #d4af37;
        }
        .card {
            background: #2c2c2c;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            padding: 1.5rem;
            margin-bottom: 2rem;
            transition: transform 0.2s ease, background 0.3s ease;
        }
        .card.light-mode {
            background: #ffffff;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .btn-primary {
            background: #d4af37;
            color: #1a1a1a;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            transition: background 0.3s ease, transform 0.1s ease;
        }
        .btn-primary:hover {
            background: #b8972e;
            transform: scale(1.05);
        }
        .btn-secondary {
            background: #4b4b4b;
            color: #f5f5f5;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            transition: background 0.3s ease, transform 0.1s ease;
        }
        .btn-secondary:hover {
            background: #3a3a3a;
            transform: scale(1.05);
        }
        .btn-danger {
            background: #dc2626;
            color: #ffffff;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            transition: background 0.3s ease, transform 0.1s ease;
        }
        .btn-danger:hover {
            background: #b91c1c;
            transform: scale(1.05);
        }
        .btn-success {
            background: #10b981;
            color: #ffffff;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            transition: background 0.3s ease, transform 0.1s ease;
        }
        .btn-success:hover {
            background: #059669;
            transform: scale(1.05);
        }
        .scanner-input {
            border: 2px solid #d4af37;
            border-radius: 8px;
            padding: 0.75rem;
            background: #3a3a3a;
            color: #f5f5f5;
            transition: border-color 0.3s ease, background 0.3s ease;
        }
        .scanner-input.light-mode {
            background: #f5f5f5;
            color: #1a1a1a;
            border: 2px solid #d4af37;
        }
        .scanner-input:focus {
            border-color: #b8972e;
            outline: none;
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2);
        }
        .scanner-container {
            position: relative;
            width: 100%;
            max-width: 640px;
            margin: 0 auto;
            aspect-ratio: 4 / 3;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #d4af37;
        }
        .scanner-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .scanner-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            height: 60px;
            border: 3px solid #ef4444;
            background: rgba(255, 255, 255, 0.2);
            pointer-events: none;
        }
        .scanner-success {
            animation: flashGreen 0.5s ease;
        }
        @keyframes flashGreen {
            0% { background-color: transparent; }
            50% { background-color: rgba(16, 185, 129, 0.3); }
            100% { background-color: transparent; }
        }
        .error-message {
            color: #f87171;
            font-weight: 500;
        }
        .success-message {
            color: #34d399;
            font-weight: 500;
        }
        .receipt {
            background: #ffffff;
            border: 2px solid #d4af37;
            border-radius: 12px;
            padding: 20px;
            max-width: 400px;
            margin: 0 auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        .receipt-logo {
            width: 80px;
            height: 80px;
            margin: 0 auto;
            border-radius: 50%;
            object-fit: cover;
        }
        .logo-preview {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 50%;
            margin-bottom: 10px;
        }
        .low-stock {
            background: rgba(220, 38, 38, 0.1);
            border-left: 4px solid #dc2626;
        }
        .notification {
            background: #dc2626;
            color: #ffffff;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        .section {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
        .section.visible {
            opacity: 1;
            transform: translateY(0);
        }
        @media print {
            body {
                background: #ffffff;
                color: #000000;
            }
            .receipt {
                border: none;
                box-shadow: none;
            }
            .no-print {
                display: none;
            }
        }
        @media (max-width: 640px) {
            .scanner-container {
                max-width: 100%;
                height: 240px;
            }
            .scanner-overlay {
                width: 80%;
                height: 50px;
            }
            .header {
                flex-direction: column;
                align-items: flex-start;
            }
            .header a {
                margin: 0.5rem 0;
            }
        }
    </style>
</head>
<body class="min-h-screen">
    <header class="header">
        <div class="logo">SuperScan</div>
        <nav>
            <a href="#" onclick="showSection('landing'); return false;">Home</a>
            <a href="#" onclick="showSection('inventory'); return false;">Inventory</a>
            <a href="#" onclick="showSection('pos'); return false;">POS</a>
            <a href="#" onclick="showSection('scanner'); return false;">Scanner</a>
            <a href="#" onclick="showSection('history'); return false;">History</a>
            <a href="#" onclick="showSection('settings'); return false;">Settings</a>
            <a href="#" onclick="toggleTheme(); return false;">Toggle Theme</a>
        </nav>
    </header>

    <div style="height: 80px;"></div>

    <div id="landingPage" class="container section">
        <h1 class="text-5xl font-bold text-center text-[#d4af37] mb-8">SuperScan</h1>
        <p class="text-center text-gray-300 mb-12 text-lg">Premium Inventory & POS System</p>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div class="card p-6 text-center cursor-pointer" onclick="showSection('inventory')">
                <h2 class="text-xl font-semibold text-[#d4af37] mb-2">Inventory Management</h2>
                <p class="text-gray-400 light-mode:text-gray-600">Manage your stock with ease.</p>
            </div>
            <div class="card p-6 text-center cursor-pointer" onclick="showSection('pos')">
                <h2 class="text-xl font-semibold text-[#d4af37] mb-2">Point of Sale</h2>
                <p class="text-gray-400 light-mode:text-gray-600">Process sales efficiently.</p>
            </div>
            <div class="card p-6 text-center cursor-pointer" onclick="showSection('scanner')">
                <h2 class="text-xl font-semibold text-[#d4af37] mb-2">Barcode Scanner</h2>
                <p class="text-gray-400 light-mode:text-gray-600">Scan barcodes seamlessly.</p>
            </div>
            <div class="card p-6 text-center cursor-pointer" onclick="showSection('history')">
                <h2 class="text-xl font-semibold text-[#d4af37] mb-2">Transaction History</h2>
                <p class="text-gray-400 light-mode:text-gray-600">View all past transactions.</p>
            </div>
            <div class="card p-6 text-center cursor-pointer" onclick="showSection('settings')">
                <h2 class="text-xl font-semibold text-[#d4af37] mb-2">Settings</h2>
                <p class="text-gray-400 light-mode:text-gray-600">Customize your app settings.</p>
            </div>
        </div>
    </div>

    <!-- Inventory Management Section -->
    <div id="inventorySection" class="container section hidden">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-4xl font-bold text-[#d4af37]">Inventory Management</h1>
            <button onclick="showSection('landing')" class="btn-secondary">Back to Menu</button>
        </div>
        <div class="card">
            <h2 class="text-2xl font-semibold text-[#d4af37] mb-4">Manage Inventory</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Add/Edit Item -->
                <div>
                    <h3 class="text-lg font-medium text-gray-200 light-mode:text-gray-800 mb-2">Add New Item</h3>
                    <div class="scanner-container">
                        <video id="inventoryScannerVideo" class="scanner-video hidden" autoplay muted playsinline></video>
                        <div id="inventoryScannerOverlay" class="scanner-overlay hidden"></div>
                    </div>
                    <p id="inventoryScannerFeedback" class="mt-2 hidden"></p>
                    <button id="inventoryTestCamera" class="btn-secondary mb-2">Test Camera</button>
                    <input id="barcodeInput" type="text" placeholder="Scan or Enter Barcode" class="scanner-input w-full mb-2">
                    <div class="flex gap-2 mb-2">
                        <button id="inventoryStartScanner" class="btn-primary">Scan Barcode</button>
                        <button id="inventoryStopScanner" class="btn-danger hidden">Stop Scanner</button>
                        <button id="inventoryManualScan" class="btn-primary">Submit Manual Barcode</button>
                    </div>
                    <input id="itemName" type="text" placeholder="Item Name" class="scanner-input w-full mb-2">
                    <input id="itemPrice" type="number" step="0.01" placeholder="Price (e.g., 9.99)" class="scanner-input w-full mb-2">
                    <input id="itemStock" type="number" placeholder="Stock Quantity" class="scanner-input w-full mb-2">
                    <button id="saveItem" class="btn-primary">Save Item</button>
                    <button id="editItem" class="btn-primary hidden">Update Item</button>
                </div>
                <!-- Item List -->
                <div>
                    <h3 class="text-lg font-medium text-gray-200 light-mode:text-gray-800 mb-2">Inventory</h3>
                    <button id="viewInventoryBtn" class="btn-primary mb-2">View Inventory</button>
                    <button id="exportInventoryBtn" class="btn-success mb-2 ml-2">Export Inventory</button>
                    <input id="inventorySearch" type="text" placeholder="Search by name or barcode..." class="scanner-input w-full mb-2">
                    <div id="lowStockAlert" class="notification hidden"></div>
                    <div id="inventoryList" class="max-h-96 overflow-y-auto">
                        <!-- Items will be dynamically added here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- POS Section -->
    <div id="posSection" class="container section hidden">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-4xl font-bold text-[#d4af37]">Point of Sale</h1>
            <button onclick="showSection('landing')" class="btn-secondary">Back to Menu</button>
        </div>
        <div class="card">
            <h2 class="text-2xl font-semibold text-[#d4af37] mb-4">Point of Sale</h2>
            <div class="scanner-container">
                <video id="posScannerVideo" class="scanner-video hidden" autoplay muted playsinline></video>
                <div id="posScannerOverlay" class="scanner-overlay hidden"></div>
            </div>
            <p id="posScannerFeedback" class="mt-2 hidden"></p>
            <button id="posTestCamera" class="btn-secondary mb-2">Test Camera</button>
            <div class="flex gap-2 mb-2">
                <input id="posBarcode" type="text" placeholder="Scan or Enter Barcode" class="scanner-input w-full">
                <input id="posQuantity" type="number" min="1" value="1" placeholder="Quantity" class="scanner-input w-24">
            </div>
            <div class="flex gap-2 mb-4">
                <button id="posStartScanner" class="btn-primary">Scan Barcode</button>
                <button id="posStopScanner" class="btn-danger hidden">Stop Scanner</button>
                <button id="posManualScan" class="btn-primary">Submit Manual Barcode</button>
                <button id="orderFromSaved" class="btn-success">Order from Saved Items</button>
            </div>
            <!-- Order from Saved Items Modal -->
            <div id="orderModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
                <div class="card p-6 w-full max-w-lg">
                    <h3 class="text-xl font-semibold text-[#d4af37] mb-4">Order from Saved Items</h3>
                    <div id="savedItemsList" class="max-h-60 overflow-y-auto mb-4"></div>
                    <button id="confirmOrder" class="btn-primary w-full">Confirm Order</button>
                    <button id="closeOrderModal" class="btn-secondary w-full mt-2">Close</button>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Cart -->
                <div>
                    <h3 class="text-lg font-medium text-gray-200 light-mode:text-gray-800 mb-2">Cart</h3>
                    <div id="cartList" class="max-h-96 overflow-y-auto">
                        <!-- Cart items will be dynamically added here -->
                    </div>
                </div>
                <!-- Summary -->
                <div>
                    <h3 class="text-lg font-medium text-gray-200 light-mode:text-gray-800 mb-2">Summary</h3>
                    <div class="bg-gray-700 light-mode:bg-gray-50 p-4 rounded-md">
                        <p class="text-gray-300 light-mode:text-gray-600">Total Items: <span id="totalItems">0</span></p>
                        <p class="text-gray-300 light-mode:text-gray-600">Total Amount: $<span id="totalAmount">0.00</span></p>
                        <button id="clearCart" class="btn-danger mt-4">Clear Cart</button>
                        <button id="printReceipt" class="btn-success mt-4 ml-2">Checkout & Print Receipt</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scanner Section -->
    <div id="scannerSection" class="container section hidden">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-4xl font-bold text-[#d4af37]">Barcode Scanner</h1>
            <button onclick="showSection('landing')" class="btn-secondary">Back to Menu</button>
        </div>
        <div class="card">
            <h2 class="text-2xl font-semibold text-[#d4af37] mb-4">Scan a Barcode</h2>
            <div class="scanner-container">
                <video id="scannerVideo" class="scanner-video hidden" autoplay muted playsinline></video>
                <div id="scannerOverlay" class="scanner-overlay hidden"></div>
            </div>
            <p id="scannerFeedback" class="mt-2 hidden"></p>
            <button id="testCamera" class="btn-secondary mb-2">Test Camera</button>
            <div class="mt-4">
                <input id="manualBarcode" type="text" placeholder="Enter barcode manually" class="scanner-input w-full mb-2">
                <button id="manualScan" class="btn-primary">Submit Manual Barcode</button>
            </div>
            <div class="flex gap-2 mt-4">
                <button id="startScanner" class="btn-primary">Start Scanner</button>
                <button id="stopScanner" class="btn-danger hidden">Stop Scanner</button>
            </div>
        </div>
    </div>

    <!-- Transaction History Section -->
    <div id="historySection" class="container section hidden">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-4xl font-bold text-[#d4af37]">Transaction History</h1>
            <button onclick="showSection('landing')" class="btn-secondary">Back to Menu</button>
        </div>
        <div class="card">
            <h2 class="text-2xl font-semibold text-[#d4af37] mb-4">Past Transactions</h2>
            <div id="transactionList" class="max-h-[600px] overflow-y-auto">
                <!-- Transactions will be dynamically added here -->
            </div>
        </div>
    </div>

    <!-- Settings Section -->
    <div id="settingsSection" class="container section hidden">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-4xl font-bold text-[#d4af37]">Settings</h1>
            <button onclick="showSection('landing')" class="btn-secondary">Back to Menu</button>
        </div>
        <div class="card">
            <h2 class="text-2xl font-semibold text-[#d4af37] mb-4">Customize Receipt</h2>
            <div class="mb-4">
                <label class="block text-gray-200 light-mode:text-gray-800 mb-2">Company Name</label>
                <input id="companyName" type="text" placeholder="Enter your company name" class="scanner-input w-full mb-2">
            </div>
            <div class="mb-4">
                <label class="block text-gray-200 light-mode:text-gray-800 mb-2">Upload Logo</label>
                <input id="logoInput" type="file" accept="image/*" class="mb-2">
                <div id="logoPreview" class="mt-2"></div>
            </div>
            <button id="saveSettings" class="btn-primary">Save Settings</button>
        </div>
    </div>

    <script>
        // Data storage
        let inventory = JSON.parse(localStorage.getItem('inventory')) || {};
        let cart = [];
        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        let scannerActive = false;
        let currentScannerSection = null;
        let lastScannedBarcode = null;
        let mediaStream = null;
        let scanCooldown = false;
        let companyName = localStorage.getItem('companyName') || '';
        let logoDataUrl = localStorage.getItem('logoDataUrl') || '';
        let theme = localStorage.getItem('theme') || 'dark';

        // Apply theme on load
        document.body.classList.toggle('light-mode', theme === 'light');
        document.querySelectorAll('.card, .scanner-input, .header').forEach(el => {
            el.classList.toggle('light-mode', theme === 'light');
        });

        // DOM Elements
        const elements = {
            landingPage: document.getElementById('landingPage'),
            inventorySection: document.getElementById('inventorySection'),
            posSection: document.getElementById('posSection'),
            scannerSection: document.getElementById('scannerSection'),
            historySection: document.getElementById('historySection'),
            settingsSection: document.getElementById('settingsSection'),
            barcodeInput: document.getElementById('barcodeInput'),
            itemName: document.getElementById('itemName'),
            itemPrice: document.getElementById('itemPrice'),
            itemStock: document.getElementById('itemStock'),
            saveItem: document.getElementById('saveItem'),
            editItem: document.getElementById('editItem'),
            inventoryList: document.getElementById('inventoryList'),
            inventorySearch: document.getElementById('inventorySearch'),
            lowStockAlert: document.getElementById('lowStockAlert'),
            viewInventoryBtn: document.getElementById('viewInventoryBtn'),
            exportInventoryBtn: document.getElementById('exportInventoryBtn'),
            posBarcode: document.getElementById('posBarcode'),
            posQuantity: document.getElementById('posQuantity'),
            cartList: document.getElementById('cartList'),
            totalItems: document.getElementById('totalItems'),
            totalAmount: document.getElementById('totalAmount'),
            clearCart: document.getElementById('clearCart'),
            printReceipt: document.getElementById('printReceipt'),
            orderFromSaved: document.getElementById('orderFromSaved'),
            orderModal: document.getElementById('orderModal'),
            savedItemsList: document.getElementById('savedItemsList'),
            confirmOrder: document.getElementById('confirmOrder'),
            closeOrderModal: document.getElementById('closeOrderModal'),
            startScanner: document.getElementById('startScanner'),
            stopScanner: document.getElementById('stopScanner'),
            testCamera: document.getElementById('testCamera'),
            scannerVideo: document.getElementById('scannerVideo'),
            scannerOverlay: document.getElementById('scannerOverlay'),
            scannerFeedback: document.getElementById('scannerFeedback'),
            manualBarcode: document.getElementById('manualBarcode'),
            manualScan: document.getElementById('manualScan'),
            inventoryStartScanner: document.getElementById('inventoryStartScanner'),
            inventoryStopScanner: document.getElementById('inventoryStopScanner'),
            inventoryTestCamera: document.getElementById('inventoryTestCamera'),
            inventoryScannerVideo: document.getElementById('inventoryScannerVideo'),
            inventoryScannerOverlay: document.getElementById('inventoryScannerOverlay'),
            inventoryScannerFeedback: document.getElementById('inventoryScannerFeedback'),
            inventoryManualScan: document.getElementById('inventoryManualScan'),
            posStartScanner: document.getElementById('posStartScanner'),
            posStopScanner: document.getElementById('posStopScanner'),
            posTestCamera: document.getElementById('posTestCamera'),
            posScannerVideo: document.getElementById('posScannerVideo'),
            posScannerOverlay: document.getElementById('posScannerOverlay'),
            posScannerFeedback: document.getElementById('posScannerFeedback'),
            posManualScan: document.getElementById('posManualScan'),
            transactionList: document.getElementById('transactionList'),
            companyName: document.getElementById('companyName'),
            logoInput: document.getElementById('logoInput'),
            logoPreview: document.getElementById('logoPreview'),
            saveSettings: document.getElementById('saveSettings')
        };

        // Check DOM elements
        for (const [key, element] of Object.entries(elements)) {
            if (!element) console.error(`Element ${key} not found in DOM`);
        }

        // Initialize
        try {
            renderInventory();
            renderCart();
            renderTransactionHistory();
            renderSettings();
            showSection('landing');
            console.log('Page initialized successfully');
        } catch (err) {
            console.error('Initialization error:', err);
            document.body.innerHTML = '<div class="text-center p-6 text-red-600">Failed to initialize application. Please refresh the page.</div>';
        }

        // Toggle Theme
        function toggleTheme() {
            theme = theme === 'dark' ? 'light' : 'dark';
            localStorage.setItem('theme', theme);
            document.body.classList.toggle('light-mode', theme === 'light');
            document.querySelectorAll('.card, .scanner-input, .header').forEach(el => {
                el.classList.toggle('light-mode', theme === 'light');
            });
        }

        // Show Section
        function showSection(section) {
            try {
                const sections = [elements.landingPage, elements.inventorySection, elements.posSection, elements.scannerSection, elements.historySection, elements.settingsSection];
                sections.forEach(s => s.classList.add('hidden'));
                sections.forEach(s => s.classList.remove('visible'));

                let targetSection;
                if (section === 'landing') {
                    targetSection = elements.landingPage;
                    stopScannerFunc();
                } else if (section === 'inventory') {
                    targetSection = elements.inventorySection;
                    stopScannerFunc();
                } else if (section === 'pos') {
                    targetSection = elements.posSection;
                    stopScannerFunc();
                } else if (section === 'scanner') {
                    targetSection = elements.scannerSection;
                } else if (section === 'history') {
                    targetSection = elements.historySection;
                    stopScannerFunc();
                } else if (section === 'settings') {
                    targetSection = elements.settingsSection;
                    stopScannerFunc();
                }
                targetSection.classList.remove('hidden');
                setTimeout(() => targetSection.classList.add('visible'), 10);
                console.log(`Switched to section: ${section}`);
            } catch (err) {
                console.error('Error in showSection:', err);
            }
        }

        // Generate Unique ID
        function generateUniqueId() {
            return 'TX' + Date.now() + Math.random().toString(36).substr(2, 9);
        }

        // Generate Order Number
        function generateOrderNumber() {
            return 'ORD' + Math.floor(Math.random() * 1000000).toString().padStart(6, '0');
        }

        // Save or Update Item
        elements.saveItem.addEventListener('click', () => {
            try {
                const barcode = elements.barcodeInput.value.trim();
                const name = elements.itemName.value.trim();
                const price = parseFloat(elements.itemPrice.value);
                const stock = parseInt(elements.itemStock.value);

                if (barcode && name && price > 0 && stock >= 0) {
                    inventory[barcode] = { name, price, stock };
                    localStorage.setItem('inventory', JSON.stringify(inventory));
                    renderInventory();
                    clearInputs();
                    showFeedback(elements.inventoryScannerFeedback, 'Item saved successfully!', true);
                } else {
                    showFeedback(elements.inventoryScannerFeedback, 'Please fill all fields with valid data.', false);
                }
            } catch (err) {
                console.error('Error saving item:', err);
                showFeedback(elements.inventoryScannerFeedback, 'Error saving item. Please try again.', false);
            }
        });

        // Edit Item
        function prepareEdit(barcode) {
            try {
                const item = inventory[barcode];
                elements.barcodeInput.value = barcode;
                elements.itemName.value = item.name;
                elements.itemPrice.value = item.price;
                elements.itemStock.value = item.stock;
                elements.barcodeInput.disabled = true;
                elements.saveItem.classList.add('hidden');
                elements.editItem.classList.remove('hidden');

                elements.editItem.onclick = () => {
                    try {
                        const name = elements.itemName.value.trim();
                        const price = parseFloat(elements.itemPrice.value);
                        const stock = parseInt(elements.itemStock.value);
                        if (name && price > 0 && stock >= 0) {
                            inventory[barcode] = { name, price, stock };
                            localStorage.setItem('inventory', JSON.stringify(inventory));
                            renderInventory();
                            clearInputs();
                            elements.barcodeInput.disabled = false;
                            elements.saveItem.classList.remove('hidden');
                            elements.editItem.classList.add('hidden');
                            showFeedback(elements.inventoryScannerFeedback, 'Item updated successfully!', true);
                        } else {
                            showFeedback(elements.inventoryScannerFeedback, 'Please fill all fields with valid data.', false);
                        }
                    } catch (err) {
                        console.error('Error updating item:', err);
                        showFeedback(elements.inventoryScannerFeedback, 'Error updating item. Please try again.', false);
                    }
                };
            } catch (err) {
                console.error('Error preparing edit:', err);
                showFeedback(elements.inventoryScannerFeedback, 'Error preparing item for edit.', false);
            }
        }

        // Delete Item
        function deleteItem(barcode) {
            try {
                if (confirm('Are you sure you want to delete this item?')) {
                    delete inventory[barcode];
                    localStorage.setItem('inventory', JSON.stringify(inventory));
                    renderInventory();
                    showFeedback(elements.inventoryScannerFeedback, 'Item deleted successfully!', true);
                }
            } catch (err) {
                console.error('Error deleting item:', err);
                showFeedback(elements.inventoryScannerFeedback, 'Error deleting item. Please try again.', false);
            }
        }

        // Search Inventory
        elements.inventorySearch.addEventListener('input', () => {
            try {
                const query = elements.inventorySearch.value.toLowerCase();
                renderInventory(query);
            } catch (err) {
                console.error('Error searching inventory:', err);
                showFeedback(elements.inventoryScannerFeedback, 'Error searching inventory.', false);
            }
        });

        // View Inventory Button
        elements.viewInventoryBtn.addEventListener('click', () => {
            elements.inventoryList.scrollIntoView({ behavior: 'smooth' });
            elements.inventoryList.style.animation = 'highlight 1s ease';
        });

        // Export Inventory to CSV
        elements.exportInventoryBtn.addEventListener('click', () => {
            try {
                const csv = ['Barcode,Name,Price,Stock'];
                for (const barcode in inventory) {
                    const item = inventory[barcode];
                    csv.push(`${barcode},${item.name},${item.price},${item.stock}`);
                }
                const csvContent = csv.join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'inventory_export.csv';
                link.click();
                URL.revokeObjectURL(link.href);
            } catch (err) {
                console.error('Error exporting inventory:', err);
                showFeedback(elements.inventoryScannerFeedback, 'Error exporting inventory.', false);
            }
        });

        // Render Inventory
        function renderInventory(searchQuery = '') {
            try {
                elements.inventoryList.innerHTML = '';
                let lowStockItems = 0;
                for (const barcode in inventory) {
                    const item = inventory[barcode];
                    const matchesSearch = !searchQuery || 
                        item.name.toLowerCase().includes(searchQuery) || 
                        barcode.toLowerCase().includes(searchQuery);
                    if (!matchesSearch) continue;

                    if (item.stock < 5) lowStockItems++;
                    const itemCard = document.createElement('div');
                    itemCard.className = `bg-gray-700 light-mode:bg-gray-50 p-4 rounded-md mb-2 flex justify-between items-center ${item.stock < 5 ? 'low-stock' : ''}`;
                    itemCard.innerHTML = `
                        <div>
                            <p class="font-medium text-gray-200 light-mode:text-gray-800">${item.name}</p>
                            <p class="text-sm text-gray-400 light-mode:text-gray-600">Barcode: ${barcode}</p>
                            <p class="text-sm text-gray-400 light-mode:text-gray-600">Price: $${item.price.toFixed(2)}</p>
                            <p class="text-sm text-gray-400 light-mode:text-gray-600">Stock: ${item.stock}</p>
                        </div>
                        <div>
                            <button onclick="prepareEdit('${barcode}')" class="text-[#d4af37] hover:text-[#b8972e] mr-2">Edit</button>
                            <button onclick="deleteItem('${barcode}')" class="text-red-500 hover:text-red-600">Delete</button>
                        </div>
                    `;
                    elements.inventoryList.appendChild(itemCard);
                }
                if (lowStockItems > 0) {
                    elements.lowStockAlert.classList.remove('hidden');
                    elements.lowStockAlert.textContent = `⚠️ ${lowStockItems} item(s) are low on stock (less than 5 units).`;
                } else {
                    elements.lowStockAlert.classList.add('hidden');
                }
            } catch (err) {
                console.error('Error rendering inventory:', err);
                showFeedback(elements.inventoryScannerFeedback, 'Error loading inventory. Please refresh.', false);
            }
        }

        // Clear Inputs
        function clearInputs() {
            try {
                elements.barcodeInput.value = '';
                elements.itemName.value = '';
                elements.itemPrice.value = '';
                elements.itemStock.value = '';
            } catch (err) {
                console.error('Error clearing inputs:', err);
            }
        }

        // POS: Add to Cart with Quantity
        function addToCart(barcode, quantity = 1) {
            try {
                if (!inventory[barcode]) {
                    showFeedback(elements.posScannerFeedback, 'Item not found in inventory.', false);
                    return;
                }
                const item = inventory[barcode];
                if (item.stock < quantity) {
                    showFeedback(elements.posScannerFeedback, `Insufficient stock for ${item.name}. Only ${item.stock} available.`, false);
                    return;
                }
                const cartItem = cart.find(i => i.barcode === barcode);
                if (cartItem) {
                    cartItem.quantity += quantity;
                } else {
                    cart.push({ barcode, ...item, quantity });
                }
                renderCart();
                showFeedback(elements.posScannerFeedback, `Added ${quantity} x ${item.name} to cart!`, true);
                elements.posScannerVideo.classList.add('scanner-success');
                setTimeout(() => elements.posScannerVideo.classList.remove('scanner-success'), 500);
                elements.posBarcode.value = '';
                elements.posQuantity.value = 1;
            } catch (err) {
                console.error('Error adding to cart:', err);
                showFeedback(elements.posScannerFeedback, 'Error adding item to cart.', false);
            }
        }

        elements.posManualScan.addEventListener('click', () => {
            try {
                const barcode = elements.posBarcode.value.trim();
                const quantity = parseInt(elements.posQuantity.value) || 1;
                if (barcode && quantity > 0) {
                    addToCart(barcode, quantity);
                } else {
                    showFeedback(elements.posScannerFeedback, 'Please enter a barcode and valid quantity.', false);
                }
            } catch (err) {
                console.error('Error in POS manual scan:', err);
                showFeedback(elements.posScannerFeedback, 'Error processing manual barcode.', false);
            }
        });

        // Order from Saved Items
        elements.orderFromSaved.addEventListener('click', () => {
            try {
                elements.savedItemsList.innerHTML = '';
                for (const barcode in inventory) {
                    const item = inventory[barcode];
                    const itemRow = document.createElement('div');
                    itemRow.className = 'flex justify-between items-center bg-gray-700 light-mode:bg-gray-50 p-3 rounded-md mb-2';
                    itemRow.innerHTML = `
                        <div>
                            <p class="font-medium text-gray-200 light-mode:text-gray-800">${item.name}</p>
                            <p class="text-sm text-gray-400 light-mode:text-gray-600">Price: $${item.price.toFixed(2)}</p>
                            <p class="text-sm text-gray-400 light-mode:text-gray-600">Stock: ${item.stock}</p>
                        </div>
                        <div class="flex items-center">
                            <input type="number" min="1" max="${item.stock}" value="1" class="quantity-input w-16 p-1 border rounded-md mr-2" data-barcode="${barcode}">
                            <button class="add-to-cart-btn text-[#d4af37] hover:text-[#b8972e]" data-barcode="${barcode}">Add</button>
                        </div>
                    `;
                    elements.savedItemsList.appendChild(itemRow);
                }

                // Add event listeners to Add buttons
                document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const barcode = btn.dataset.barcode;
                        const quantityInput = btn.parentElement.querySelector('.quantity-input');
                        const quantity = parseInt(quantityInput.value);
                        if (quantity > 0 && quantity <= inventory[barcode].stock) {
                            addToCart(barcode, quantity);
                        } else {
                            showFeedback(elements.posScannerFeedback, 'Invalid quantity or insufficient stock.', false);
                        }
                    });
                });

                elements.orderModal.classList.remove('hidden');
            } catch (err) {
                console.error('Error opening order modal:', err);
                showFeedback(elements.posScannerFeedback, 'Error loading saved items.', false);
            }
        });

        elements.closeOrderModal.addEventListener('click', () => {
            elements.orderModal.classList.add('hidden');
        });

        elements.confirmOrder.addEventListener('click', () => {
            elements.orderModal.classList.add('hidden');
            showFeedback(elements.posScannerFeedback, 'Items added to cart!', true);
        });

        // Render Cart
        function renderCart() {
            try {
                elements.cartList.innerHTML = '';
                let total = 0;
                let totalItems = 0;
                cart.forEach((item, index) => {
                    const itemTotal = item.price * item.quantity;
                    total += itemTotal;
                    totalItems += item.quantity;
                    const cartItem = document.createElement('div');
                    cartItem.className = 'bg-gray-700 light-mode:bg-gray-50 p-4 rounded-md mb-2 flex justify-between items-center';
                    cartItem.innerHTML = `
                        <div>
                            <p class="font-medium text-gray-200 light-mode:text-gray-800">${item.name}</p>
                            <p class="text-sm text-gray-400 light-mode:text-gray-600">Price: $${item.price.toFixed(2)} x ${item.quantity}</p>
                            <p class="text-sm text-gray-400 light-mode:text-gray-600">Total: $${itemTotal.toFixed(2)}</p>
                        </div>
                        <button onclick="removeFromCart(${index})" class="text-red-500 hover:text-red-600">Remove</button>
                    `;
                    elements.cartList.appendChild(cartItem);
                });
                elements.totalItems.textContent = totalItems;
                elements.totalAmount.textContent = total.toFixed(2);
            } catch (err) {
                console.error('Error rendering cart:', err);
                showFeedback(elements.posScannerFeedback, 'Error loading cart. Please refresh.', false);
            }
        }

        // Remove from Cart
        function removeFromCart(index) {
            try {
                cart.splice(index, 1);
                renderCart();
                showFeedback(elements.posScannerFeedback, 'Item removed from cart!', true);
            } catch (err) {
                console.error('Error removing from cart:', err);
                showFeedback(elements.posScannerFeedback, 'Error removing item from cart.', false);
            }
        }

        // Clear Cart
        elements.clearCart.addEventListener('click', () => {
            try {
                cart = [];
                renderCart();
                showFeedback(elements.posScannerFeedback, 'Cart cleared!', true);
            } catch (err) {
                console.error('Error clearing cart:', err);
                showFeedback(elements.posScannerFeedback, 'Error clearing cart.', false);
            }
        });

        // Generate Receipt HTML
        function generateReceipt(transaction, totalItems) {
            return `
                <div class="receipt">
                    ${logoDataUrl ? `<img src="${logoDataUrl}" class="receipt-logo" alt="Company Logo">` : '<div class="receipt-logo">No Logo</div>'}
                    <h2 class="text-2xl font-bold text-center text-gray-800 mt-4">${companyName ? companyName + ' Receipt' : 'Receipt'}</h2>
                    <p class="text-center text-gray-600 mt-2">Transaction ID: ${transaction.id}</p>
                    <p class="text-center text-gray-600">Order Number: ${transaction.orderNumber}</p>
                    <p class="text-center text-gray-600">Date: ${transaction.date}</p>
                    <hr class="my-4 border-gray-300">
                    <table class="w-full mt-4 border-collapse">
                        <thead>
                            <tr class="border-b border-gray-300">
                                <th class="text-left py-2 text-gray-800">Item</th>
                                <th class="text-center py-2 text-gray-800">Qty</th>
                                <th class="text-right py-2 text-gray-800">Price</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${transaction.items.map(item => `
                                <tr>
                                    <td class="py-2 text-gray-800">${item.name}</td>
                                    <td class="text-center py-2 text-gray-800">${item.quantity}</td>
                                    <td class="text-right py-2 text-gray-800">$${(item.price * item.quantity).toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                        <tfoot>
                            <tr class="border-t border-gray-300 font-semibold">
                                <td class="py-2 text-gray-800">Total (${totalItems} items)</td>
                                <td></td>
                                <td class="text-right py-2 text-gray-800">$${transaction.total.toFixed(2)}</td>
                            </tr>
                        </tfoot>
                    </table>
                    <p class="text-center text-gray-600 mt-4">Thank you for your purchase!</p>
                </div>
            `;
        }

        // Checkout & Print Receipt
        elements.printReceipt.addEventListener('click', () => {
            try {
                if (cart.length === 0) {
                    showFeedback(elements.posScannerFeedback, 'Cart is empty.', false);
                    return;
                }

                // Update stock
                cart.forEach(item => {
                    if (inventory[item.barcode]) {
                        inventory[item.barcode].stock -= item.quantity;
                    }
                });
                localStorage.setItem('inventory', JSON.stringify(inventory));
                renderInventory();

                // Generate transaction
                const transactionId = generateUniqueId();
                const orderNumber = generateOrderNumber();
                const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
                const transaction = {
                    id: transactionId,
                    orderNumber: orderNumber,
                    date: new Date().toLocaleString(),
                    items: [...cart],
                    total: cart.reduce((sum, item) => sum + (item.price * item.quantity), 0)
                };
                transactions.push(transaction);
                localStorage.setItem('transactions', JSON.stringify(transactions));
                renderTransactionHistory();

                // Create receipt dynamically
                const receiptDiv = document.createElement('div');
                receiptDiv.className = 'no-print';
                receiptDiv.innerHTML = generateReceipt(transaction, totalItems);
                document.body.appendChild(receiptDiv);

                // Print receipt
                window.print();

                // Remove receipt from DOM after printing
                setTimeout(() => {
                    document.body.removeChild(receiptDiv);
                }, 1000);

                // Clear cart after printing
                cart = [];
                renderCart();
            } catch (err) {
                console.error('Error during checkout:', err);
                showFeedback(elements.posScannerFeedback, 'Error during checkout. Please try again.', false);
            }
        });

        // Undo Last Transaction
        function undoLastTransaction() {
            try {
                if (transactions.length === 0) {
                    alert('No transactions to undo.');
                    return;
                }
                const lastTransaction = transactions.pop();
                lastTransaction.items.forEach(item => {
                    if (inventory[item.barcode]) {
                        inventory[item.barcode].stock += item.quantity;
                    }
                });
                localStorage.setItem('inventory', JSON.stringify(inventory));
                localStorage.setItem('transactions', JSON.stringify(transactions));
                renderInventory();
                renderTransactionHistory();
                alert('Last transaction undone successfully.');
            } catch (err) {
                console.error('Error undoing transaction:', err);
                alert('Error undoing transaction.');
            }
        }

        // Print Receipt from History
        function printTransactionReceipt(index) {
            try {
                const transaction = transactions[index];
                const totalItems = transaction.items.reduce((sum, item) => sum + item.quantity, 0);
                const receiptDiv = document.createElement('div');
                receiptDiv.className = 'no-print';
                receiptDiv.innerHTML = generateReceipt(transaction, totalItems);
                document.body.appendChild(receiptDiv);

                window.print();

                setTimeout(() => {
                    document.body.removeChild(receiptDiv);
                }, 1000);
            } catch (err) {
                console.error('Error printing transaction receipt:', err);
                alert('Error printing receipt.');
            }
        }

        // Render Transaction History
        function renderTransactionHistory() {
            try {
                elements.transactionList.innerHTML = '';
                transactions.forEach((transaction, index) => {
                    const totalItems = transaction.items.reduce((sum, item) => sum + item.quantity, 0);
                    const transactionCard = document.createElement('div');
                    transactionCard.className = 'bg-gray-700 light-mode:bg-gray-50 p-4 rounded-md mb-4';
                    let itemsHtml = '';
                    transaction.items.forEach(item => {
                        itemsHtml += `<p class="text-sm text-gray-400 light-mode:text-gray-600">${item.name} - $${item.price.toFixed(2)} x ${item.quantity}</p>`;
                    });
                    const isLatest = index === transactions.length - 1;
                    transactionCard.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-lg font-medium text-gray-200 light-mode:text-gray-800">Transaction ID: ${transaction.id}</h3>
                            <p class="text-sm text-gray-400 light-mode:text-gray-600">Order #: ${transaction.orderNumber}</p>
                        </div>
                        <p class="text-sm text-gray-400 light-mode:text-gray-600">Date: ${transaction.date}</p>
                        ${itemsHtml}
                        <p class="text-sm font-semibold text-gray-200 light-mode:text-gray-800 mt-2">Total (${totalItems} items): $${transaction.total.toFixed(2)}</p>
                        <div class="flex gap-2 mt-2">
                            <button onclick="printTransactionReceipt(${index})" class="btn-success">Print Receipt</button>
                            ${isLatest ? `<button onclick="undoLastTransaction()" class="btn-danger">Undo Transaction</button>` : ''}
                        </div>
                    `;
                    elements.transactionList.appendChild(transactionCard);
                });
            } catch (err) {
                console.error('Error rendering transaction history:', err);
            }
        }

        // Show Feedback
        function showFeedback(element, message, isSuccess) {
            try {
                element.textContent = message;
                element.classList.remove('hidden', isSuccess ? 'error-message' : 'success-message');
                element.classList.add(isSuccess ? 'success-message' : 'error-message');
                setTimeout(() => element.classList.add('hidden'), 5000);
            } catch (err) {
                console.error('Error showing feedback:', err);
            }
        }

        // Render Settings
        function renderSettings() {
            try {
                elements.companyName.value = companyName;
                if (logoDataUrl) {
                    const img = document.createElement('img');
                    img.src = logoDataUrl;
                    img.className = 'logo-preview';
                    elements.logoPreview.innerHTML = '';
                    elements.logoPreview.appendChild(img);
                }
            } catch (err) {
                console.error('Error rendering settings:', err);
            }
        }

        // Handle Logo Upload and Company Name
        elements.logoInput.addEventListener('change', (event) => {
            try {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        logoDataUrl = e.target.result;
                        const img = document.createElement('img');
                        img.src = logoDataUrl;
                        img.className = 'logo-preview';
                        elements.logoPreview.innerHTML = '';
                        elements.logoPreview.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                }
            } catch (err) {
                console.error('Error uploading logo:', err);
            }
        });

        elements.saveSettings.addEventListener('click', () => {
            try {
                companyName = elements.companyName.value.trim();
                localStorage.setItem('companyName', companyName);
                localStorage.setItem('logoDataUrl', logoDataUrl);
                renderSettings();
                alert('Settings saved successfully!');
            } catch (err) {
                console.error('Error saving settings:', err);
                alert('Error saving settings. Please try again.');
            }
        });

        // Check Camera Access
        async function checkCameraAccess(feedbackElement, videoElement, overlayElement) {
            try {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('MediaDevices API not supported in this browser.');
                }
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: "environment",
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    }
                });
                mediaStream = stream;
                videoElement.srcObject = stream;
                videoElement.classList.remove('hidden');
                overlayElement.classList.remove('hidden');
                console.log('Camera access granted and stream started');
                return true;
            } catch (err) {
                console.error('Camera access error:', err);
                let errorMessage = 'Unable to access camera: ';
                if (err.name === 'NotAllowedError') {
                    errorMessage += 'Camera access was denied. Please allow camera access in your browser settings and refresh the page.';
                } else if (err.name === 'NotFoundError') {
                    errorMessage += 'No camera found on this device. Please use a device with a camera or enter the barcode manually.';
                } else {
                    errorMessage += `${err.message}. Please ensure your device has a camera and try again.`;
                }
                showFeedback(feedbackElement, errorMessage, false);
                return false;
            }
        }

        // Stop Camera Stream
        function stopCameraStream() {
            try {
                if (mediaStream) {
                    mediaStream.getTracks().forEach(track => track.stop());
                    mediaStream = null;
                    console.log('Camera stream stopped');
                }
            } catch (err) {
                console.error('Error stopping camera stream:', err);
            }
        }

        // Test Camera
        function testCamera(section, videoElement, overlayElement, feedbackElement) {
            try {
                checkCameraAccess(feedbackElement, videoElement, overlayElement).then(success => {
                    if (success) {
                        showFeedback(feedbackElement, 'Camera feed is working! Click "Scan Barcode" to start scanning.', true);
                    }
                });
            } catch (err) {
                console.error(`Error testing camera (${section}):`, err);
                showFeedback(feedbackElement, 'Error testing camera. Please check the console for details.', false);
            }
        }

        // Generic Barcode Scanner Function with Auto-Processing
        function startScanner(section, videoElement, overlayElement, feedbackElement, startButton, stopButton, callback) {
            if (scannerActive) {
                console.warn(`Scanner already active in ${currentScannerSection}. Ignoring request for ${section}.`);
                return;
            }

            try {
                currentScannerSection = section;
                checkCameraAccess(feedbackElement, videoElement, overlayElement).then(hasAccess => {
                    if (!hasAccess) return;

                    if (!window.Quagga) {
                        console.error('QuaggaJS not loaded');
                        showFeedback(feedbackElement, 'Scanner library failed to load. Please refresh the page.', false);
                        stopCameraStream();
                        return;
                    }

                    Quagga.init({
                        inputStream: {
                            name: "Live",
                            type: "LiveStream",
                            target: videoElement,
                            constraints: {
                                facingMode: "environment",
                                width: { ideal: 640 },
                                height: { ideal: 480 }
                            }
                        },
                        decoder: {
                            readers: ["ean_reader", "upc_reader", "code_128_reader"]
                        },
                        locate: true
                    }, function(err) {
                        if (err) {
                            console.error(`Quagga init error (${section}):`, err);
                            showFeedback(feedbackElement, `Failed to initialize scanner: ${err.message}. Please try again or use manual input.`, false);
                            stopCameraStream();
                            videoElement.classList.add('hidden');
                            overlayElement.classList.add('hidden');
                            return;
                        }
                        try {
                            Quagga.start();
                            scannerActive = true;
                            videoElement.classList.remove('hidden');
                            overlayElement.classList.remove('hidden');
                            startButton.classList.add('hidden');
                            stopButton.classList.remove('hidden');
                            feedbackElement.classList.add('hidden');
                            console.log(`Scanner started for ${section}`);
                        } catch (startErr) {
                            console.error(`Error starting Quagga (${section}):`, startErr);
                            showFeedback(feedbackElement, 'Error starting scanner. Please try again or use manual input.', false);
                            stopCameraStream();
                            videoElement.classList.add('hidden');
                            overlayElement.classList.add('hidden');
                        }
                    });

                    Quagga.onDetected(function(data) {
                        if (scanCooldown) return; // Prevent multiple scans during cooldown

                        try {
                            const barcode = data.codeResult.code;
                            lastScannedBarcode = barcode;
                            showFeedback(feedbackElement, `Scanned: ${barcode}`, true);
                            videoElement.classList.add('scanner-success');
                            if (section === 'pos') {
                                const quantity = parseInt(elements.posQuantity.value) || 1;
                                callback(barcode, quantity);
                            } else {
                                callback(barcode);
                            }

                            // Set cooldown to prevent immediate re-scan
                            scanCooldown = true;
                            setTimeout(() => {
                                scanCooldown = false;
                            }, 2000); // 2-second cooldown
                        } catch (detectErr) {
                            console.error(`Error processing detected barcode (${section}):`, detectErr);
                            showFeedback(feedbackElement, 'Error processing barcode. Please try again.', false);
                        }
                    });
                });
            } catch (err) {
                console.error(`Scanner startup error (${section}):`, err);
                showFeedback(feedbackElement, 'Error starting scanner. Please try again or use manual input.', false);
            }
        }

        // Stop Scanner
        function stopScannerFunc() {
            if (!scannerActive) return;

            try {
                if (window.Quagga) {
                    Quagga.stop();
                }
                stopCameraStream();
                scannerActive = false;
                lastScannedBarcode = null;
                scanCooldown = false;
                if (currentScannerSection === 'inventory') {
                    elements.inventoryScannerVideo.classList.add('hidden');
                    elements.inventoryScannerOverlay.classList.add('hidden');
                    elements.inventoryStartScanner.classList.remove('hidden');
                    elements.inventoryStopScanner.classList.add('hidden');
                    elements.inventoryScannerFeedback.classList.add('hidden');
                } else if (currentScannerSection === 'pos') {
                    elements.posScannerVideo.classList.add('hidden');
                    elements.posScannerOverlay.classList.add('hidden');
                    elements.posStartScanner.classList.remove('hidden');
                    elements.posStopScanner.classList.add('hidden');
                    elements.posScannerFeedback.classList.add('hidden');
                } else if (currentScannerSection === 'scanner') {
                    elements.scannerVideo.classList.add('hidden');
                    elements.scannerOverlay.classList.add('hidden');
                    elements.startScanner.classList.remove('hidden');
                    elements.stopScanner.classList.add('hidden');
                    elements.scannerFeedback.classList.add('hidden');
                }
                currentScannerSection = null;
                console.log('Scanner stopped');
            } catch (err) {
                console.error('Error stopping scanner:', err);
                if (currentScannerSection === 'inventory') {
                    showFeedback(elements.inventoryScannerFeedback, 'Error stopping scanner. Please refresh the page.', false);
                } else if (currentScannerSection === 'pos') {
                    showFeedback(elements.posScannerFeedback, 'Error stopping scanner. Please refresh the page.', false);
                } else if (currentScannerSection === 'scanner') {
                    showFeedback(elements.scannerFeedback, 'Error stopping scanner. Please refresh the page.', false);
                }
            }
        }

        // Test Camera Buttons
        elements.inventoryTestCamera.addEventListener('click', () => {
            testCamera('inventory', elements.inventoryScannerVideo, elements.inventoryScannerOverlay, elements.inventoryScannerFeedback);
        });

        elements.posTestCamera.addEventListener('click', () => {
            testCamera('pos', elements.posScannerVideo, elements.posScannerOverlay, elements.posScannerFeedback);
        });

        elements.testCamera.addEventListener('click', () => {
            testCamera('scanner', elements.scannerVideo, elements.scannerOverlay, elements.scannerFeedback);
        });

        // Inventory Scanner
        elements.inventoryStartScanner.addEventListener('click', () => {
            startScanner('inventory', elements.inventoryScannerVideo, elements.inventoryScannerOverlay, elements.inventoryScannerFeedback, elements.inventoryStartScanner, elements.inventoryStopScanner, (barcode) => {
                elements.barcodeInput.value = barcode;
                showFeedback(elements.inventoryScannerFeedback, `Confirmed barcode: ${barcode}`, true);
            });
        });

        elements.inventoryStopScanner.addEventListener('click', stopScannerFunc);

        elements.inventoryManualScan.addEventListener('click', () => {
            try {
                const barcode = elements.barcodeInput.value.trim();
                if (barcode) {
                    elements.barcodeInput.value = barcode;
                    showFeedback(elements.inventoryScannerFeedback, `Manual barcode entered: ${barcode}`, true);
                } else {
                    showFeedback(elements.inventoryScannerFeedback, 'Please enter a barcode.', false);
                }
            } catch (err) {
                console.error('Error in inventory manual scan:', err);
                showFeedback(elements.inventoryScannerFeedback, 'Error processing manual barcode.', false);
            }
        });

        // POS Scanner
        elements.posStartScanner.addEventListener('click', () => {
            startScanner('pos', elements.posScannerVideo, elements.posScannerOverlay, elements.posScannerFeedback, elements.posStartScanner, elements.posStopScanner, (barcode, quantity) => {
                addToCart(barcode, quantity);
            });
        });

        elements.posStopScanner.addEventListener('click', stopScannerFunc);

        // Main Scanner Section
        elements.startScanner.addEventListener('click', () => {
            startScanner('scanner', elements.scannerVideo, elements.scannerOverlay, elements.scannerFeedback, elements.startScanner, elements.stopScanner, (barcode) => {
                let message = `Confirmed Barcode: ${barcode}`;
                if (inventory[barcode]) {
                    const item = inventory[barcode];
                    message += ` - ${item.name} ($${item.price.toFixed(2)})`;
                    cart.push({ barcode, ...item, quantity: 1 });
                    renderCart();
                } else {
                    message += ' - Item not found in inventory.';
                }
                showFeedback(elements.scannerFeedback, message, true);
            });
        });

        elements.stopScanner.addEventListener('click', stopScannerFunc);

        elements.manualScan.addEventListener('click', () => {
            try {
                const barcode = elements.manualBarcode.value.trim();
                if (barcode) {
                    let message = `Manual Barcode: ${barcode}`;
                    if (inventory[barcode]) {
                        const item = inventory[barcode];
                        message += ` - ${item.name} ($${item.price.toFixed(2)})`;
                        cart.push({ barcode, ...item, quantity: 1 });
                        renderCart();
                    } else {
                        message += ' - Item not found in inventory.';
                    }
                    elements.manualBarcode.value = '';
                    showFeedback(elements.scannerFeedback, message, true);
                } else {
                    showFeedback(elements.scannerFeedback, 'Please enter a barcode.', false);
                }
            } catch (err) {
                console.error('Error in main scanner manual scan:', err);
                showFeedback(elements.scannerFeedback, 'Error processing manual barcode.', false);
            }
        });
    </script>
</body>
</html>